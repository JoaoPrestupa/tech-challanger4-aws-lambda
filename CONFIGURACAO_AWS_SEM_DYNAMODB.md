# ğŸ”§ Guia Completo de ConfiguraÃ§Ã£o AWS - Apenas RDS PostgreSQL

## ğŸ“‹ Ãndice
1. [PreparaÃ§Ã£o Inicial](#1-preparaÃ§Ã£o-inicial)
2. [IAM - UsuÃ¡rios e PermissÃµes](#2-iam---usuÃ¡rios-e-permissÃµes)
3. [VPC - Rede Virtual](#3-vpc---rede-virtual)
4. [RDS - Banco de Dados PostgreSQL](#4-rds---banco-de-dados-postgresql)
5. [SQS - Filas de Mensagens](#5-sqs---filas-de-mensagens)
6. [SNS - NotificaÃ§Ãµes](#6-sns---notificaÃ§Ãµes)
7. [SES - ServiÃ§o de E-mail](#7-ses---serviÃ§o-de-e-mail)
8. [Lambda - FunÃ§Ãµes Serverless](#8-lambda---funÃ§Ãµes-serverless)
9. [API Gateway - Entrada HTTP](#9-api-gateway---entrada-http)
10. [EventBridge - Agendamento](#10-eventbridge---agendamento)
11. [CloudWatch - Monitoramento](#11-cloudwatch---monitoramento)
12. [ValidaÃ§Ã£o Final](#12-validaÃ§Ã£o-final)

---

## 1. PreparaÃ§Ã£o Inicial

### 1.1 Criar Conta AWS

1. Acesse [https://aws.amazon.com/](https://aws.amazon.com/)
2. Clique em **"Create an AWS Account"**
3. Preencha:
   - **Email**: Seu e-mail principal
   - **Password**: Senha forte (mÃ­n. 8 caracteres)
   - **AWS account name**: Nome da sua empresa/projeto
4. Complete o cadastro com:
   - InformaÃ§Ãµes de contato
   - InformaÃ§Ãµes de pagamento (cartÃ£o de crÃ©dito)
   - VerificaÃ§Ã£o de identidade (SMS)
5. Escolha o plano **Basic Support (Free)**

### 1.2 Configurar MFA (Multi-Factor Authentication)

âš ï¸ **IMPORTANTE PARA SEGURANÃ‡A**

1. No console AWS, clique no seu nome (canto superior direito)
2. Selecione **"Security credentials"**
3. Em **Multi-factor authentication (MFA)**, clique **"Assign MFA device"**
4. Escolha **"Virtual MFA device"**
5. Use um app autenticador:
   - Google Authenticator (Android/iOS)
   - Microsoft Authenticator (Android/iOS)
   - Authy (Desktop/Mobile)
6. Escaneie o QR code
7. Digite dois cÃ³digos consecutivos
8. Clique **"Assign MFA"**

### 1.3 Configurar Billing Alerts

1. Acesse **AWS Console** > **Billing**
2. No menu lateral, clique **"Billing preferences"**
3. Marque:
   - âœ… **Receive PDF Invoice By Email**
   - âœ… **Receive Free Tier Usage Alerts**
   - âœ… **Receive Billing Alerts**
4. Digite seu e-mail
5. Clique **"Save preferences"**

6. VÃ¡ para **CloudWatch** (use a busca no topo)
7. No menu lateral, clique **"Alarms"** > **"Billing"**
8. Clique **"Create alarm"**
9. Configure:
   - **Metric**: Total Estimated Charge
   - **Threshold**: $50 USD (ajuste conforme necessÃ¡rio)
   - **Actions**: Criar novo tÃ³pico SNS com seu e-mail
10. Clique **"Create alarm"**
11. **Confirme o e-mail** que vocÃª receberÃ¡!

### 1.4 Escolher RegiÃ£o

âš ï¸ **USE A MESMA REGIÃƒO PARA TODOS OS SERVIÃ‡OS**

Recomendado: **us-east-1 (N. Virginia)**

**Por quÃª?**
- RegiÃ£o mais barata
- SES totalmente funcional
- Maior disponibilidade de serviÃ§os

**Como verificar:**
- Canto superior direito do console AWS
- Se nÃ£o estiver em **us-east-1**, clique e selecione

---

## 2. IAM - UsuÃ¡rios e PermissÃµes

### 2.1 Criar UsuÃ¡rio para Desenvolvimento

1. Acesse **IAM** no console AWS
2. Menu lateral: **Users** > **Add users**
3. Configure:
   - **User name**: `terraform-deploy` ou `dev-user`
   - **Access type**: 
     - âœ… **Programmatic access** (para AWS CLI/Terraform)
     - âœ… **AWS Management Console access** (para console)
   - **Console password**: Autogenerated ou Custom
   - **Require password reset**: âŒ (desmarque se for vocÃª)
4. Clique **"Next: Permissions"**

### 2.2 Anexar PolÃ­ticas

**OpÃ§Ã£o 1: Para Desenvolvimento (mais permissivo)**
1. Selecione **"Attach existing policies directly"**
2. Procure e marque:
   - âœ… `AdministratorAccess`
3. Clique **"Next"** atÃ© **"Create user"**

**OpÃ§Ã£o 2: Para ProduÃ§Ã£o (mais restritivo)**
1. Selecione **"Attach existing policies directly"**
2. Procure e marque:
   - âœ… `AWSLambda_FullAccess`
   - âœ… `AmazonRDSFullAccess`
   - âœ… `AmazonSQSFullAccess`
   - âœ… `AmazonSNSFullAccess`
   - âœ… `AmazonSESFullAccess`
   - âœ… `CloudWatchFullAccess`
   - âœ… `AmazonVPCFullAccess`
   - âœ… `IAMFullAccess`
   - âœ… `AmazonAPIGatewayAdministrator`

### 2.3 Salvar Credenciais

âš ï¸ **ÃšLTIMA CHANCE DE VER AS CREDENCIAIS**

1. ApÃ³s criar, vocÃª verÃ¡:
   - **Access key ID**: `AKIAIOSFODNN7EXAMPLE`
   - **Secret access key**: `wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY`
2. Clique **"Download .csv"** e guarde em local seguro
3. **NUNCA** compartilhe essas credenciais
4. **NUNCA** comite no Git

### 2.4 Configurar AWS CLI

```bash
aws configure
```

Digite:
- **AWS Access Key ID**: Cole sua Access Key
- **AWS Secret Access Key**: Cole sua Secret Key
- **Default region name**: `us-east-1`
- **Default output format**: `json`

Teste:
```bash
aws sts get-caller-identity
```

Deve retornar suas informaÃ§Ãµes de conta.

---

## 3. VPC - Rede Virtual

### 3.1 Criar VPC

1. Acesse **VPC** no console
2. Clique **"Create VPC"**
3. Configure:
   - **Resources to create**: VPC and more
   - **Name tag**: `feedback-system-vpc`
   - **IPv4 CIDR**: `10.0.0.0/16`
   - **IPv6 CIDR block**: No IPv6 CIDR block
   - **Tenancy**: Default
   - **Number of Availability Zones**: 2
   - **Number of public subnets**: 0
   - **Number of private subnets**: 2
   - **NAT gateways**: None (para economizar) ou In 1 AZ (para produÃ§Ã£o)
   - **VPC endpoints**: None
4. Clique **"Create VPC"**

### 3.2 Criar Subnets (AutomÃ¡tico)

As subnets serÃ£o criadas automaticamente:
- `feedback-system-vpc-subnet-private1-us-east-1a` (10.0.1.0/24)
- `feedback-system-vpc-subnet-private2-us-east-1b` (10.0.2.0/24)

### 3.3 Criar Security Group para RDS

1. No menu VPC, clique **"Security Groups"**
2. Clique **"Create security group"**
3. Configure:
   - **Security group name**: `feedback-rds-sg`
   - **Description**: `Security group for RDS PostgreSQL`
   - **VPC**: Selecione `feedback-system-vpc`
4. **Inbound rules**:
   - Clique **"Add rule"**
   - **Type**: PostgreSQL
   - **Port**: 5432
   - **Source**: Custom > `10.0.0.0/16` (toda a VPC)
   - **Description**: `Allow from VPC`
5. **Outbound rules**: Manter padrÃ£o (All traffic)
6. Clique **"Create security group"**

### 3.4 Criar Security Group para Lambda

1. Clique **"Create security group"**
2. Configure:
   - **Security group name**: `feedback-lambda-sg`
   - **Description**: `Security group for Lambda functions`
   - **VPC**: Selecione `feedback-system-vpc`
3. **Inbound rules**: Nenhuma (Lambda nÃ£o recebe conexÃµes diretas)
4. **Outbound rules**: 
   - Manter padrÃ£o (All traffic) - permite Lambda acessar RDS, SQS, SNS, etc.
5. Clique **"Create security group"**

6. **Volte ao Security Group do RDS** e adicione regra:
   - **Type**: PostgreSQL
   - **Port**: 5432
   - **Source**: Custom > Selecione o SG `feedback-lambda-sg`
   - **Description**: `Allow from Lambda`

---

## 4. RDS - Banco de Dados PostgreSQL

### 4.1 Criar Subnet Group

1. Acesse **RDS** no console
2. Menu lateral: **Subnet groups** > **Create DB subnet group**
3. Configure:
   - **Name**: `feedback-db-subnet-group`
   - **Description**: `Subnet group for feedback system`
   - **VPC**: Selecione `feedback-system-vpc`
   - **Availability Zones**: Selecione `us-east-1a` e `us-east-1b`
   - **Subnets**: Selecione as duas subnets privadas criadas
4. Clique **"Create"**

### 4.2 Criar Banco de Dados RDS

1. Menu lateral: **Databases** > **Create database**
2. **Choose a database creation method**:
   - âšª Standard create

3. **Engine options**:
   - **Engine type**: PostgreSQL
   - **Version**: PostgreSQL 15.4-R2 (ou mais recente)

4. **Templates**:
   - âšª Free tier (para testes)
   - âšª Dev/Test (para desenvolvimento)
   - âšª Production (para produÃ§Ã£o)

5. **Settings**:
   - **DB instance identifier**: `feedback-system-db`
   - **Master username**: `postgres` (padrÃ£o) ou `admin`
   - **Master password**: 
     - âšª Auto generate a password (recomendado)
     - âšª Self managed (crie uma senha forte com 16+ caracteres)
   - **Confirm password**: Digite novamente

6. **DB instance class**:
   - **Burstable classes**: `db.t3.micro` (Free Tier) ou `db.t3.small`

7. **Storage**:
   - **Storage type**: General Purpose SSD (gp3)
   - **Allocated storage**: 20 GiB
   - **Storage autoscaling**: 
     - âœ… Enable storage autoscaling
     - **Maximum storage threshold**: 100 GiB

8. **Connectivity**:
   - **Compute resource**: Don't connect to an EC2 compute resource
   - **Network type**: IPv4
   - **Virtual private cloud (VPC)**: `feedback-system-vpc`
   - **DB subnet group**: `feedback-db-subnet-group`
   - **Public access**: âŒ No
   - **VPC security group**: Existing > Selecione `feedback-rds-sg`
   - **Availability Zone**: No preference

9. **Database authentication**:
   - âšª Password authentication

10. **Additional configuration**:
    - **Initial database name**: `feedback_db` âš ï¸ **IMPORTANTE: nÃ£o esqueÃ§a disso!**
    - **DB parameter group**: default
    - **Option group**: default
    - **Backup**:
      - âœ… Enable automatic backups
      - **Backup retention period**: 7 days
      - **Backup window**: No preference
    - **Encryption**:
      - âœ… Enable encryption
      - **AWS KMS key**: (default) aws/rds
    - **Monitoring**:
      - âœ… Enable Enhanced Monitoring (opcional)
    - **Maintenance**:
      - âœ… Enable auto minor version upgrade
      - **Maintenance window**: No preference
    - **Deletion protection**:
      - âŒ Disable (para testes)
      - âœ… Enable (para produÃ§Ã£o)

11. Clique **"Create database"**

â±ï¸ **Aguarde 10-15 minutos** para o banco ser criado.

### 4.3 Salvar Credenciais

1. Se escolheu **Auto generate password**:
   - Clique em **"View credential details"**
   - **COPIE E SALVE** o usuÃ¡rio e senha
   - VocÃª nÃ£o conseguirÃ¡ ver a senha novamente!

2. Anote o **Endpoint**:
   - Na lista de databases, clique no seu DB
   - Copie o **Endpoint** (ex: `feedback-system-db.c9xxx.us-east-1.rds.amazonaws.com`)
   - Copie o **Port**: `5432`

**ğŸ“ Anote em local seguro:**
```
DB_HOST=feedback-system-db.c9xxx.us-east-1.rds.amazonaws.com
DB_PORT=5432
DB_NAME=feedback_db
DB_USERNAME=postgres
DB_PASSWORD=sua-senha-aqui
```

---

## 5. SQS - Filas de Mensagens

### 5.1 Criar Dead Letter Queue (DLQ)

**Criar primeiro a DLQ para poder referenciar na fila principal**

1. Acesse **SQS** no console
2. Clique **"Create queue"**
3. Configure:
   - **Type**: âšª Standard
   - **Name**: `notificacao-urgencia-dlq`
   - **Configuration**:
     - **Visibility timeout**: 5 minutes
     - **Message retention period**: 14 days
     - **Delivery delay**: 0 seconds
     - **Maximum message size**: 256 KB
     - **Receive message wait time**: 0 seconds
   - **Encryption**: Server-side encryption (opcional)
   - **Access policy**: Basic
4. Clique **"Create queue"**
5. **Copie o ARN** da DLQ criada (vocÃª vai precisar!)

### 5.2 Criar Fila Principal

1. Clique **"Create queue"** novamente
2. Configure:
   - **Type**: âšª Standard
   - **Name**: `notificacao-urgencia-queue`
   - **Configuration**:
     - **Visibility timeout**: 5 minutes (300 segundos)
     - **Message retention period**: 4 days
     - **Delivery delay**: 0 seconds
     - **Maximum message size**: 256 KB
     - **Receive message wait time**: 10 seconds (Long polling)

3. **Dead-letter queue**:
   - âœ… Enabled
   - **Choose queue**: Selecione `notificacao-urgencia-dlq`
   - **Maximum receives**: 3

4. **Encryption** (opcional):
   - âœ… Server-side encryption
   - **AWS KMS key**: AWS managed key (default)

5. **Access policy**:
   - âšª Basic
   - **Define who can send messages**: Only the queue owner
   - **Define who can receive messages**: Only the queue owner

6. Clique **"Create queue"**

7. **Copie a URL** da fila criada:
   - Ex: `https://sqs.us-east-1.amazonaws.com/123456789012/notificacao-urgencia-queue`

**ğŸ“ Anote:**
```
SQS_NOTIFICACAO_URL=https://sqs.us-east-1.amazonaws.com/123456789012/notificacao-urgencia-queue
```

---

## 6. SNS - NotificaÃ§Ãµes

### 6.1 Criar TÃ³pico SNS

1. Acesse **SNS** no console
2. Menu lateral: **Topics** > **Create topic**
3. Configure:
   - **Type**: âšª Standard
   - **Name**: `urgencia-topic`
   - **Display name**: `Feedback Urgente`

4. **Encryption** (opcional):
   - âœ… Enable encryption
   - **KMS key**: (default) aws/sns

5. **Access policy**:
   - **Method**: âšª Basic
   - **Define who can publish**: Only the topic owner
   - **Define who can subscribe**: Only the topic owner

6. **Delivery retry policy (HTTP/S)**: Manter padrÃ£o

7. **Delivery status logging**: Habilitar para CloudWatch (opcional)

8. Clique **"Create topic"**

9. **Copie o ARN** do tÃ³pico:
   - Ex: `arn:aws:sns:us-east-1:123456789012:urgencia-topic`

**ğŸ“ Anote:**
```
SNS_URGENCIA_ARN=arn:aws:sns:us-east-1:123456789012:urgencia-topic
```

### 6.2 Criar SubscriÃ§Ã£o (E-mail)

1. Na pÃ¡gina do tÃ³pico criado, clique **"Create subscription"**
2. Configure:
   - **Protocol**: Email
   - **Endpoint**: Seu e-mail (ex: `admin@exemplo.com`)
3. Clique **"Create subscription"**

4. **IMPORTANTE**: 
   - VocÃª receberÃ¡ um e-mail: **"AWS Notification - Subscription Confirmation"**
   - **Clique no link** para confirmar a subscriÃ§Ã£o
   - Verifique a pasta de spam se nÃ£o aparecer

5. Repita para cada administrador que deve receber notificaÃ§Ãµes

### 6.3 Adicionar MÃºltiplos E-mails

Repita o passo 6.2 para cada e-mail:
- admin1@exemplo.com
- admin2@exemplo.com
- gerente@exemplo.com

---

## 7. SES - ServiÃ§o de E-mail

### 7.1 Verificar E-mail Remetente

1. Acesse **SES** no console
2. âš ï¸ **Certifique-se de estar em us-east-1** (SES sÃ³ funciona bem lÃ¡)
3. Menu lateral: **Verified identities** > **Create identity**
4. Configure:
   - **Identity type**: âšª Email address
   - **Email address**: `noreply@seu-dominio.com`
     - Ou use um e-mail pessoal para testes: `seu-email@gmail.com`
5. Clique **"Create identity"**

6. **VerificaÃ§Ã£o**:
   - VocÃª receberÃ¡ um e-mail: **"Amazon Web Services â€“ Email Address Verification Request"**
   - **Clique no link** para verificar
   - Status mudarÃ¡ de "Unverified" para "Verified"

**ğŸ“ Anote:**
```
SES_FROM_EMAIL=noreply@seu-dominio.com (ou seu-email@gmail.com)
```

### 7.2 Verificar E-mails dos DestinatÃ¡rios (Sandbox)

**Enquanto estiver no SES Sandbox**, vocÃª precisa verificar TODOS os e-mails destinatÃ¡rios:

1. Repita o passo 7.1 para cada e-mail de administrador:
   - admin1@exemplo.com
   - admin2@exemplo.com
   - etc.

2. Cada pessoa receberÃ¡ um e-mail de verificaÃ§Ã£o

**ğŸ“ Anote:**
```
SES_ADMIN_EMAILS=admin1@exemplo.com,admin2@exemplo.com
```

### 7.3 Solicitar SaÃ­da do Sandbox (ProduÃ§Ã£o)

**Apenas para produÃ§Ã£o - permite enviar para qualquer e-mail**

1. Menu lateral: **Account dashboard**
2. VocÃª verÃ¡: **"Your account is in the sandbox"**
3. Clique **"Request production access"**
4. Preencha o formulÃ¡rio:
   - **Mail type**: Transactional
   - **Website URL**: URL do seu sistema (ou "N/A" se nÃ£o tiver)
   - **Use case description**:
     ```
     Sistema de feedback de cursos online.
     Enviaremos:
     1. NotificaÃ§Ãµes de feedbacks crÃ­ticos para administradores
     2. RelatÃ³rios semanais automÃ¡ticos
     Estimativa: < 1000 e-mails/mÃªs
     Todos os e-mails sÃ£o opt-in (destinatÃ¡rios confirmados)
     ```
   - **Additional contact addresses**: Seu e-mail
   - **Compliance with AWS policies**: âœ… Confirme

5. Clique **"Submit request"**
6. Aguarde aprovaÃ§Ã£o (1-2 dias Ãºteis)

---

## 8. Lambda - FunÃ§Ãµes Serverless

### âš ï¸ PRÃ‰-REQUISITO: Compilar o JAR

Antes de criar as Lambdas, compile o projeto:

```cmd
cd C:\Users\joao.pedro\Downloads\fase4\fase4
mvn clean package -DskipTests
```

Isso gerarÃ¡: `target\fase4-0.0.1-SNAPSHOT.jar` (~50-80MB)

### 8.1 Criar IAM Role para Lambda 1 (Receber Feedback)

1. Acesse **IAM** > **Roles** > **Create role**
2. **Trusted entity type**: AWS service
3. **Use case**: Lambda
4. Clique **"Next"**
5. **Permissions policies**: Procure e adicione:
   - `AWSLambdaBasicExecutionRole`
   - `AWSLambdaVPCAccessExecutionRole`
6. Clique **"Next"**
7. **Role name**: `feedback-lambda-receber-role`
8. Clique **"Create role"**

9. **Adicionar polÃ­tica inline** (permissÃµes especÃ­ficas):
   - Clique no role criado
   - **Permissions** > **Add permissions** > **Create inline policy**
   - Clique em **JSON** e cole:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "sqs:SendMessage"
      ],
      "Resource": "arn:aws:sqs:us-east-1:*:notificacao-urgencia-queue"
    },
    {
      "Effect": "Allow",
      "Action": [
        "cloudwatch:PutMetricData"
      ],
      "Resource": "*"
    }
  ]
}
```

10. **Name**: `FeedbackLambdaReceberPolicy`
11. Clique **"Create policy"**

### 8.2 Criar Lambda 1: Receber Feedback

1. Acesse **Lambda** > **Functions** > **Create function**
2. Configure:
   - âšª Author from scratch
   - **Function name**: `feedback-system-receber-feedback`
   - **Runtime**: Java 21
   - **Architecture**: x86_64
   - **Permissions**: 
     - âšª Use an existing role
     - **Existing role**: `feedback-lambda-receber-role`
3. Clique **"Create function"**

4. **Upload do cÃ³digo**:
   - Na seÃ§Ã£o **Code**, clique **"Upload from"** > **.zip or .jar file**
   - Clique **"Upload"**
   - Selecione: `target\fase4-0.0.1-SNAPSHOT.jar`
   - Aguarde o upload (pode demorar 1-2 minutos)

5. **ConfiguraÃ§Ãµes BÃ¡sicas**:
   - Clique na aba **"Configuration"**
   - **General configuration** > **Edit**:
     - **Memory**: 1024 MB (recomendado para Spring Boot)
     - **Timeout**: 30 seconds
     - **Ephemeral storage**: 512 MB (padrÃ£o)
   - Clique **"Save"**

6. **Handler**:
   - **Runtime settings** > **Edit**
   - **Handler**: `lambda.fase4.lambda.ReceberFeedbackHandler::handleRequest`
   - Clique **"Save"**

7. **VariÃ¡veis de ambiente**:
   - **Environment variables** > **Edit** > **Add environment variable**
   - Adicione cada uma:

```
AWS_REGION=us-east-1
SQS_NOTIFICACAO_URL=https://sqs.us-east-1.amazonaws.com/SEU-ACCOUNT-ID/notificacao-urgencia-queue
DB_HOST=feedback-system-db.c9xxx.us-east-1.rds.amazonaws.com
DB_PORT=5432
DB_NAME=feedback_db
DB_USERNAME=postgres
DB_PASSWORD=SUA-SENHA-DO-RDS
```

   - Clique **"Save"**

8. **VPC** (para acessar RDS):
   - **VPC** > **Edit**
   - **VPC**: Selecione `feedback-system-vpc`
   - **Subnets**: Selecione as 2 subnets privadas
   - **Security groups**: Selecione `feedback-lambda-sg`
   - Clique **"Save"**

â±ï¸ **Aguarde 1-2 minutos** para a Lambda ser configurada na VPC.

### 8.3 Criar IAM Role para Lambda 2 (Enviar NotificaÃ§Ã£o)

Repita o passo 8.1, mas:
- **Role name**: `feedback-lambda-notificacao-role`
- **Inline policy JSON**:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "sqs:ReceiveMessage",
        "sqs:DeleteMessage",
        "sqs:GetQueueAttributes"
      ],
      "Resource": "arn:aws:sqs:us-east-1:*:notificacao-urgencia-queue"
    },
    {
      "Effect": "Allow",
      "Action": [
        "sns:Publish"
      ],
      "Resource": "arn:aws:sns:us-east-1:*:urgencia-topic"
    },
    {
      "Effect": "Allow",
      "Action": [
        "ses:SendEmail",
        "ses:SendRawEmail"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "cloudwatch:PutMetricData"
      ],
      "Resource": "*"
    }
  ]
}
```

### 8.4 Criar Lambda 2: Enviar NotificaÃ§Ã£o

Repita o passo 8.2, mas:
- **Function name**: `feedback-system-enviar-notificacao`
- **Existing role**: `feedback-lambda-notificacao-role`
- **Handler**: `lambda.fase4.lambda.EnviarNotificacaoHandler::handleRequest`
- **Memory**: 512 MB
- **Timeout**: 5 minutes (300 seconds)
- **VPC**: Selecione `feedback-system-vpc` (mesma config da Lambda 1)
- **Environment variables**:

```
AWS_REGION=us-east-1
SNS_URGENCIA_ARN=arn:aws:sns:us-east-1:SEU-ACCOUNT-ID:urgencia-topic
SES_FROM_EMAIL=noreply@seu-dominio.com
SES_ADMIN_EMAILS=admin1@exemplo.com,admin2@exemplo.com
DB_HOST=feedback-system-db.c9xxx.us-east-1.rds.amazonaws.com
DB_PORT=5432
DB_NAME=feedback_db
DB_USERNAME=postgres
DB_PASSWORD=SUA-SENHA-DO-RDS
```

### 8.5 Conectar SQS Ã  Lambda 2

1. Na pÃ¡gina da **Lambda 2** (`feedback-system-enviar-notificacao`)
2. Clique **"Add trigger"**
3. Configure:
   - **Trigger configuration**: SQS
   - **SQS queue**: Selecione `notificacao-urgencia-queue`
   - **Batch size**: 10
   - **Batch window**: 0 seconds
   - âœ… Enable trigger
4. Clique **"Add"**

### 8.6 Criar IAM Role para Lambda 3 (Gerar RelatÃ³rio)

Repita o passo 8.1, mas:
- **Role name**: `feedback-lambda-relatorio-role`
- **Inline policy JSON**:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ses:SendEmail",
        "ses:SendRawEmail"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "cloudwatch:PutMetricData"
      ],
      "Resource": "*"
    }
  ]
}
```

### 8.7 Criar Lambda 3: Gerar RelatÃ³rio

Repita o passo 8.2, mas:
- **Function name**: `feedback-system-gerar-relatorio`
- **Existing role**: `feedback-lambda-relatorio-role`
- **Handler**: `lambda.fase4.lambda.GerarRelatorioHandler::handleRequest`
- **Memory**: 1024 MB
- **Timeout**: 5 minutes
- **VPC**: Selecione `feedback-system-vpc` (mesma config da Lambda 1)
- **Environment variables**:

```
AWS_REGION=us-east-1
SES_FROM_EMAIL=noreply@seu-dominio.com
SES_ADMIN_EMAILS=admin1@exemplo.com,admin2@exemplo.com
DB_HOST=feedback-system-db.c9xxx.us-east-1.rds.amazonaws.com
DB_PORT=5432
DB_NAME=feedback_db
DB_USERNAME=postgres
DB_PASSWORD=SUA-SENHA-DO-RDS
```

---

## 9. API Gateway - Entrada HTTP

### 9.1 Criar HTTP API

1. Acesse **API Gateway** > **Create API**
2. Escolha **HTTP API** > **Build**
3. Configure:
   - **API name**: `feedback-system-api`
   - **Integrations**: NÃ£o adicionar agora
4. Clique **"Next"**

5. **Configure routes**:
   - Clique **"Add integration"**
   - **Method**: POST
   - **Resource path**: `/avaliacao`
   - **Integration target**: Lambda function
   - **Lambda function**: `feedback-system-receber-feedback`
   - **Integration name**: (auto preenchido)
6. Clique **"Next"**

7. **Configure stages**:
   - **Stage name**: `prod`
   - **Auto-deploy**: âœ… Enabled
8. Clique **"Next"**

9. Revise e clique **"Create"**

### 9.2 Configurar CORS

1. Na pÃ¡gina da API, clique **"CORS"** no menu lateral
2. Configure:
   - **Access-Control-Allow-Origin**: `*` (ou seu domÃ­nio especÃ­fico)
   - **Access-Control-Allow-Headers**: `Content-Type,Authorization`
   - **Access-Control-Allow-Methods**: `POST,GET,OPTIONS`
   - **Max age**: 300
3. Clique **"Save"**

### 9.3 Obter URL do Endpoint

1. Menu lateral: **Stages** > **prod**
2. Copie a **Invoke URL**:
   - Ex: `https://abc123xyz.execute-api.us-east-1.amazonaws.com`
3. Seu endpoint completo serÃ¡:
   - `https://abc123xyz.execute-api.us-east-1.amazonaws.com/prod/avaliacao`

**ğŸ“ Anote:**
```
API_ENDPOINT=https://abc123xyz.execute-api.us-east-1.amazonaws.com/prod/avaliacao
```

### 9.4 Testar o Endpoint

```bash
curl -X POST https://SUA-URL/prod/avaliacao \
  -H "Content-Type: application/json" \
  -d "{\"descricao\":\"Teste via API Gateway\",\"nota\":9}"
```

No Windows PowerShell:
```powershell
Invoke-RestMethod -Method Post -Uri "https://SUA-URL/prod/avaliacao" `
  -Headers @{"Content-Type"="application/json"} `
  -Body '{"descricao":"Teste via API Gateway","nota":9}'
```

---

## 10. EventBridge - Agendamento

### 10.1 Criar Regra de Agendamento

1. Acesse **EventBridge** > **Rules** > **Create rule**
2. Configure:
   - **Name**: `feedback-relatorio-semanal`
   - **Description**: `Trigger semanal para geraÃ§Ã£o de relatÃ³rio`
   - **Event bus**: default
   - **Rule type**: âšª Schedule
3. Clique **"Next"**

4. **Schedule pattern**:
   - âšª Cron-based schedule
   - **Cron expression**: `0 9 ? * MON *`
     - Significa: Todo segunda-feira Ã s 9h UTC (6h BrasÃ­lia)
   - **Flexible time window**: Off
5. Clique **"Next"**

6. **Target**:
   - **Target types**: AWS service
   - **Select a target**: Lambda function
   - **Function**: `feedback-system-gerar-relatorio`
7. Clique **"Next"**

8. **Permissions**:
   - âšª Create a new role for this specific resource
9. Clique **"Next"**

10. Revise e clique **"Create rule"**

### 10.2 Testar Manualmente

Para testar sem esperar segunda-feira:

1. Acesse **Lambda** > **Functions** > `feedback-system-gerar-relatorio`
2. Clique na aba **"Test"**
3. **Event name**: `TestEvent`
4. **Template**: Scheduled Event (EventBridge)
5. Clique **"Save"**
6. Clique **"Test"**
7. Verifique os logs e seu e-mail

Ou via AWS CLI:
```bash
aws lambda invoke --function-name feedback-system-gerar-relatorio --payload "{}" response.json
```

---

## 11. CloudWatch - Monitoramento

### 11.1 Visualizar Logs

1. Acesse **CloudWatch** > **Log groups**
2. VocÃª verÃ¡:
   - `/aws/lambda/feedback-system-receber-feedback`
   - `/aws/lambda/feedback-system-enviar-notificacao`
   - `/aws/lambda/feedback-system-gerar-relatorio`
3. Clique em qualquer um para ver os logs em tempo real

### 11.2 Criar Alarme para Erros Lambda

1. **CloudWatch** > **Alarms** > **Create alarm**
2. **Select metric**:
   - **All metrics** > **AWS/Lambda** > **By Function Name**
   - **Metric name**: Errors
   - Marque as 3 Lambdas
3. Clique **"Select metric"**

4. Configure:
   - **Statistic**: Sum
   - **Period**: 5 minutes
   - **Threshold type**: Static
   - **Whenever Errors is...**: Greater/Equal > 5
5. Clique **"Next"**

6. **Notification**:
   - **Alarm state trigger**: In alarm
   - **Send a notification to**: Selecione `urgencia-topic` (criado anteriormente)
7. Clique **"Next"**

8. **Name**: `feedback-lambda-errors-alarm`
9. **Description**: `Alarme quando houver muitos erros nas Lambdas`
10. Clique **"Create alarm"**

### 11.3 Criar Alarme para DLQ

1. **CloudWatch** > **Alarms** > **Create alarm**
2. **Select metric**:
   - **All metrics** > **AWS/SQS** > **Queue Metrics**
   - **Metric name**: ApproximateNumberOfMessagesVisible
   - Selecione: `notificacao-urgencia-dlq`
3. Clique **"Select metric"**

4. Configure:
   - **Statistic**: Maximum
   - **Period**: 5 minutes
   - **Threshold**: Greater > 0
5. Clique **"Next"**

6. **Notification**: Mesmo tÃ³pico `urgencia-topic`
7. **Name**: `feedback-dlq-messages-alarm`
8. **Description**: `Alarme quando mensagens forem para DLQ`
9. Clique **"Create alarm"**

### 11.4 Criar Alarme para RDS ConexÃµes

1. **CloudWatch** > **Alarms** > **Create alarm**
2. **Select metric**:
   - **All metrics** > **RDS** > **Per-Database Metrics**
   - **Metric name**: DatabaseConnections
   - Selecione seu RDS: `feedback-system-db`
3. Clique **"Select metric"**

4. Configure:
   - **Threshold**: Greater > 80 (ajuste conforme seu plano)
5. **Notification**: Mesmo tÃ³pico
6. **Name**: `feedback-rds-connections-high`
7. Clique **"Create alarm"**

### 11.5 Criar Dashboard

1. **CloudWatch** > **Dashboards** > **Create dashboard**
2. **Dashboard name**: `FeedbackSystem`
3. Clique **"Create dashboard"**

4. **Add widget** > **Line graph**:
   - Adicione mÃ©tricas:
     - Lambda > Invocations (3 funÃ§Ãµes)
     - Lambda > Errors (3 funÃ§Ãµes)
     - Lambda > Duration (3 funÃ§Ãµes)
5. Clique **"Create widget"**

6. **Add widget** > **Number**:
   - Adicione:
     - SQS > ApproximateNumberOfMessagesVisible
     - SQS > NumberOfMessagesSent
     - RDS > DatabaseConnections
7. Clique **"Create widget"**

8. Clique **"Save dashboard"**

---

## 12. ValidaÃ§Ã£o Final

### 12.1 Checklist de ConfiguraÃ§Ã£o

Marque cada item conforme completa:

**IAM**
- [ ] UsuÃ¡rio criado com permissÃµes adequadas
- [ ] Credenciais AWS CLI configuradas
- [ ] MFA habilitado na conta root

**VPC/Rede**
- [ ] VPC criada com 2 subnets privadas
- [ ] Security Group para RDS configurado
- [ ] Security Group para Lambda configurado

**Banco de Dados**
- [ ] RDS PostgreSQL criado e disponÃ­vel (status: Available)
- [ ] Endpoint do RDS anotado
- [ ] Credenciais salvas em local seguro

**Mensageria**
- [ ] SQS fila principal criada
- [ ] SQS DLQ criada e vinculada
- [ ] SNS tÃ³pico criado
- [ ] E-mails subscritos e confirmados

**E-mail**
- [ ] SES e-mail remetente verificado
- [ ] SES e-mails destinatÃ¡rios verificados (sandbox)
- [ ] ProduÃ§Ã£o aprovada (opcional)

**Lambda**
- [ ] JAR compilado com sucesso
- [ ] Lambda 1 criada, configurada e na VPC
- [ ] Lambda 2 criada, conectada ao SQS e na VPC
- [ ] Lambda 3 criada e na VPC
- [ ] Todas as variÃ¡veis de ambiente configuradas

**API e Agendamento**
- [ ] API Gateway configurado
- [ ] CORS habilitado
- [ ] Endpoint anotado
- [ ] EventBridge regra semanal criada

**Monitoramento**
- [ ] Logs visÃ­veis no CloudWatch
- [ ] Alarmes configurados
- [ ] Dashboard criado

### 12.2 Testes de IntegraÃ§Ã£o

#### Teste 1: API Gateway â†’ Lambda 1 â†’ RDS

**Windows PowerShell:**
```powershell
Invoke-RestMethod -Method Post -Uri "https://SUA-URL/prod/avaliacao" `
  -Headers @{"Content-Type"="application/json"} `
  -Body '{"descricao":"Teste de integraÃ§Ã£o completo","nota":9}'
```

**Linux/Mac:**
```bash
curl -X POST https://SUA-URL/prod/avaliacao \
  -H "Content-Type: application/json" \
  -d '{"descricao":"Teste de integraÃ§Ã£o completo","nota":9}'
```

**Verificar**:
- [ ] Resposta HTTP 201 Created recebida
- [ ] Log aparece no CloudWatch da Lambda 1
- [ ] Registro criado no RDS (conecte via cliente SQL e consulte)

#### Teste 2: NotificaÃ§Ã£o CrÃ­tica (Fluxo Completo)

**Windows PowerShell:**
```powershell
Invoke-RestMethod -Method Post -Uri "https://SUA-URL/prod/avaliacao" `
  -Headers @{"Content-Type"="application/json"} `
  -Body '{"descricao":"Problema crÃ­tico no curso! Precisa atenÃ§Ã£o urgente.","nota":2}'
```

**Linux/Mac:**
```bash
curl -X POST https://SUA-URL/prod/avaliacao \
  -H "Content-Type: application/json" \
  -d '{"descricao":"Problema crÃ­tico no curso! Precisa atenÃ§Ã£o urgente.","nota":2}'
```

**Verificar (aguarde 1-2 minutos)**:
- [ ] Resposta 201 recebida
- [ ] Mensagem aparece na fila SQS (console AWS > SQS > Messages available)
- [ ] Lambda 2 Ã© acionada automaticamente (ver logs)
- [ ] E-mail recebido via SES (cheque inbox e spam)
- [ ] NotificaÃ§Ã£o SNS recebida por e-mail
- [ ] Registro marcado como `notificacao_enviada = true` no RDS

#### Teste 3: RelatÃ³rio Manual

**Windows CMD:**
```cmd
aws lambda invoke --function-name feedback-system-gerar-relatorio --payload "{}" response.json
```

**Verificar**:
- [ ] Comando retorna sucesso (StatusCode: 200)
- [ ] Lambda executada com sucesso (ver logs)
- [ ] E-mail de relatÃ³rio recebido
- [ ] RelatÃ³rio contÃ©m estatÃ­sticas corretas

### 12.3 Verificar Status dos ServiÃ§os

**RDS:**
```bash
aws rds describe-db-instances --db-instance-identifier feedback-system-db --query "DBInstances[0].DBInstanceStatus"
```
Deve retornar: `"available"`

**Lambda:**
```bash
aws lambda get-function --function-name feedback-system-receber-feedback --query "Configuration.State"
```
Deve retornar: `"Active"`

**SQS:**
```bash
aws sqs get-queue-attributes --queue-url https://sqs.us-east-1.amazonaws.com/SEU-ACCOUNT/notificacao-urgencia-queue --attribute-names ApproximateNumberOfMessages
```
Deve retornar nÃºmero de mensagens na fila.

### 12.4 Conectar ao RDS para Verificar Dados

**OpÃ§Ã£o 1: DBeaver / pgAdmin (recomendado)**

Como o RDS estÃ¡ em subnet privada sem acesso pÃºblico, vocÃª tem 3 opÃ§Ãµes:

**A) Criar um Bastion Host (EC2)**
1. Crie uma instÃ¢ncia EC2 t2.micro na mesma VPC
2. Em subnet pÃºblica com IP pÃºblico
3. SSH para a EC2 e depois conecte ao RDS

**B) Habilitar acesso pÃºblico temporariamente (apenas para testes)**
1. No console RDS, edite seu DB
2. **Publicly accessible**: Yes
3. **VPC security group**: Adicione seu IP na regra de entrada
4. ApÃ³s testar, reverta para "No"

**C) Usar AWS Systems Manager Session Manager (sem SSH)**
1. Mais seguro que bastion host
2. Requer configuraÃ§Ã£o adicional

**OpÃ§Ã£o 2: Query via Lambda**

Crie uma Lambda temporÃ¡ria para fazer queries:
```java
// CÃ³digo simples para SELECT * FROM avaliacoes
```

### 12.5 Verificar Custos

1. Acesse **Billing** > **Cost Explorer**
2. **Date range**: Last 7 days
3. **Group by**: Service
4. Verifique custos por serviÃ§o:
   - **RDS**: ~$15-25/mÃªs (db.t3.micro)
   - **Lambda**: Quase $0 (dentro do free tier para testes)
   - **NAT Gateway**: $30-45/mÃªs (se habilitou)
   - **SQS, SNS, SES**: < $1/mÃªs
   - **Total esperado**: $15-25/mÃªs (sem NAT) ou $50-70/mÃªs (com NAT)

ğŸ’¡ **Para economizar**: Se nÃ£o habilitou NAT Gateway, suas Lambdas sÃ³ conseguem acessar RDS (na mesma VPC) e nÃ£o conseguem acessar internet (SQS, SNS, SES). Para acessar serviÃ§os AWS sem NAT, use **VPC Endpoints** (gratuitos).

---

## ğŸš¨ Troubleshooting Comum

### Problema: Lambda timeout ao acessar RDS
**Causa**: Lambda nÃ£o estÃ¡ na VPC ou Security Group bloqueando
**SoluÃ§Ã£o**: 
1. Verificar se Lambda estÃ¡ em subnet privada da VPC
2. Verificar Security Group do RDS permite entrada do SG da Lambda
3. Aumentar timeout da Lambda para 30s

### Problema: Lambda nÃ£o consegue enviar para SQS/SNS
**Causa**: Lambda em VPC privada sem internet
**SoluÃ§Ã£o**:
- **OpÃ§Ã£o 1**: Criar NAT Gateway ($30-45/mÃªs)
- **OpÃ§Ã£o 2**: Criar VPC Endpoints para SQS e SNS (gratuito)

### Problema: E-mails nÃ£o chegam (SES)
**SoluÃ§Ã£o**:
1. Verificar se e-mail remetente estÃ¡ verificado
2. Verificar se estÃ¡ em sandbox (precisa verificar destinatÃ¡rios)
3. Verificar logs da Lambda para erros
4. Verificar pasta de spam
5. Verificar limites de envio do SES

### Problema: SQS nÃ£o dispara Lambda
**SoluÃ§Ã£o**:
1. Verificar event source mapping estÃ¡ enabled
2. Verificar permissÃµes da Lambda (role permite SQS)
3. Verificar logs do CloudWatch
4. Testar enviar mensagem manual para a fila

### Problema: API Gateway retorna 502/504
**SoluÃ§Ã£o**:
1. Lambda provavelmente estÃ¡ com timeout
2. Verificar logs da Lambda
3. Aumentar timeout da Lambda
4. Verificar se Lambda consegue inicializar (Spring Boot demora)

### Problema: RDS nÃ£o conecta
**SoluÃ§Ã£o**:
1. Verificar endpoint estÃ¡ correto
2. Verificar credenciais
3. Verificar porta 5432
4. Verificar Security Group
5. Verificar se database `feedback_db` foi criado

---

## ğŸ“š Resumo das Credenciais e URLs

Mantenha esse resumo em local seguro:

```ini
# AWS Account
AWS_ACCOUNT_ID=123456789012
AWS_REGION=us-east-1

# RDS PostgreSQL
DB_HOST=feedback-system-db.c9xxx.us-east-1.rds.amazonaws.com
DB_PORT=5432
DB_NAME=feedback_db
DB_USERNAME=postgres
DB_PASSWORD=SUA-SENHA-SEGURA

# SQS
SQS_NOTIFICACAO_URL=https://sqs.us-east-1.amazonaws.com/123456789012/notificacao-urgencia-queue

# SNS
SNS_URGENCIA_ARN=arn:aws:sns:us-east-1:123456789012:urgencia-topic

# SES
SES_FROM_EMAIL=noreply@seu-dominio.com
SES_ADMIN_EMAILS=admin1@exemplo.com,admin2@exemplo.com

# API Gateway
API_ENDPOINT=https://abc123xyz.execute-api.us-east-1.amazonaws.com/prod/avaliacao

# Lambda Functions
LAMBDA_1=feedback-system-receber-feedback
LAMBDA_2=feedback-system-enviar-notificacao
LAMBDA_3=feedback-system-gerar-relatorio

# VPC
VPC_ID=vpc-xxxxx
SUBNET_1=subnet-xxxxx
SUBNET_2=subnet-xxxxx
SG_RDS=sg-xxxxx
SG_LAMBDA=sg-xxxxx
```

---

## ğŸ¯ PrÃ³ximos Passos

ApÃ³s configurar tudo e testar:

1. âœ… **Desabilitar acesso pÃºblico ao RDS** (se habilitou para testes)
2. âœ… **Criar VPC Endpoints** para economizar (SQS, SNS, SES)
3. âœ… **Configurar backups automÃ¡ticos** do RDS
4. âœ… **Documentar todas as URLs e credenciais**
5. âœ… **Configurar alertas de custo** ($50/mÃªs)
6. âœ… **Testar disaster recovery** (restore de backup)
7. âœ… **Implementar CI/CD** com Terraform ou CloudFormation
8. âœ… **Adicionar autenticaÃ§Ã£o** (API Keys ou AWS Cognito)
9. âœ… **Solicitar saÃ­da do SES Sandbox** (produÃ§Ã£o)
10. âœ… **Configurar domÃ­nio customizado** no API Gateway

---

## ğŸ“ Suporte

- **DocumentaÃ§Ã£o AWS**: https://docs.aws.amazon.com/
- **AWS Support**: https://console.aws.amazon.com/support/
- **AWS Free Tier**: https://aws.amazon.com/free/
- **Calculadora de Custos**: https://calculator.aws/
- **Status AWS**: https://status.aws.amazon.com/

---

**âœ… ConfiguraÃ§Ã£o completa sem DynamoDB!**
**Sistema usando apenas RDS PostgreSQL para persistÃªncia.**
**Guia atualizado para Tech Challenge - Fase 4**

